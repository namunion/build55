name: KeepAlive + Nexus Auto Supervisor (Final v3 Stable)

on:
  schedule:
    - cron: "*/15 * * * *"  # Kiá»ƒm tra má»—i 15 phÃºt
  workflow_dispatch:

jobs:
  keepalive:
    runs-on: ubuntu-latest
    env:
      PERSONAL_TOKEN: ${{ secrets.PERSONAL_TOKEN }}

    steps:
      - name: ðŸ§° CÃ i cÃ´ng cá»¥ cáº§n thiáº¿t
        run: |
          sudo apt update -y
          sudo apt install -y gh jq curl

      - name: ðŸ” ÄÄƒng nháº­p GitHub CLI
        run: |
          echo "${PERSONAL_TOKEN}" | gh auth login --with-token
          gh auth status || true

      - name: ðŸ§© PhÃ¡t hiá»‡n Codespace Ä‘ang cháº¡y
        id: detect
        run: |
          NAME=$(gh codespace list --json name,state --jq '.[] | select(.state=="Available") | .name' | head -n 1)
          if [ -z "$NAME" ]; then
            echo "âš ï¸ KhÃ´ng cÃ³ Codespace Ä‘ang hoáº¡t Ä‘á»™ng."
            exit 0
          fi
          echo "ðŸ§© Äang xá»­ lÃ½ Codespace: $NAME"
          echo "name=$NAME" >> $GITHUB_OUTPUT

      - name: â±ï¸ Kiá»ƒm tra thá»i gian hoáº¡t Ä‘á»™ng & restart náº¿u gáº§n háº¿t háº¡n
        id: uptime
        run: |
          CODE=${{ steps.detect.outputs.name }}
          START_TIME=$(gh codespace list --json name,lastUsedAt --jq ".[] | select(.name==\"$CODE\") | .lastUsedAt")
          if [ -z "$START_TIME" ]; then
            echo "âš ï¸ KhÃ´ng thá»ƒ xÃ¡c Ä‘á»‹nh thá»i gian báº¯t Ä‘áº§u."
            exit 0
          fi
          START_EPOCH=$(date -d "$START_TIME" +%s)
          NOW_EPOCH=$(date +%s)
          MINUTES=$(( (NOW_EPOCH - START_EPOCH) / 60 ))
          echo "ðŸ•’ Codespace $CODE Ä‘Ã£ cháº¡y $MINUTES phÃºt."
          echo "runtime=$MINUTES" >> $GITHUB_OUTPUT

          if [ "$MINUTES" -ge 355 ]; then
            echo "âš ï¸ Gáº§n háº¿t 6 tiáº¿ng â€” restart..."
            gh codespace stop --codespace "$CODE"
            sleep 25
            gh codespace start --codespace "$CODE"
            echo "restarted=true" >> $GITHUB_OUTPUT
          else
            echo "âœ… CÃ²n trong giá»›i háº¡n an toÃ n."
            echo "restarted=false" >> $GITHUB_OUTPUT
          fi

      - name: ðŸ’¤ Gá»­i keep-alive ping
        if: steps.detect.outputs.name != ''
        run: |
          CODE=${{ steps.detect.outputs.name }}
          echo "ðŸ’¤ Gá»­i keep-alive ping cho $CODE..."
          gh codespace ssh --codespace "$CODE" -- bash -lc '
            mkdir -p /workspaces/build55/keepalive
            echo "[KeepAlive] $(date)" >> /workspaces/build55/keepalive/ping.log
          ' || echo "âš ï¸ Ping lá»—i nháº¹ (Codespace cÃ³ thá»ƒ Ä‘ang táº¡m ngá»§)"
          echo "âœ… Keep-alive ping gá»­i thÃ nh cÃ´ng!"

      - name: ðŸ’» Kiá»ƒm tra & khá»Ÿi Ä‘á»™ng Nexus (náº¿u chÆ°a cháº¡y)
        if: steps.detect.outputs.name != ''
        run: |
          CODE=${{ steps.detect.outputs.name }}
          echo "ðŸ’» Kiá»ƒm tra tiáº¿n trÃ¬nh Nexus..."

          # âš™ï¸ Táº¯t táº¡m thÃ´ng bÃ¡o cá»§a NVS Ä‘á»ƒ khá»i log lá»—i vá»› váº©n
          gh codespace ssh --codespace "$CODE" -- bash -lc 'unset NVS_HOME; unset NVS_DIR'

          # ðŸ” Kiá»ƒm tra xem Nexus cÃ³ Ä‘ang cháº¡y khÃ´ng
          IS_RUNNING=$(gh codespace ssh --codespace "$CODE" -- bash -lc "pgrep -af nexus-network | awk '{print \$1}' || true")

          if [ -n "$IS_RUNNING" ]; then
            echo "âœ… Nexus Ä‘ang cháº¡y (PID: $IS_RUNNING)"
          else
            echo "âš™ï¸ Nexus chÆ°a cháº¡y â€” khá»Ÿi Ä‘á»™ng headless..."
            gh codespace ssh --codespace "$CODE" -- bash -lc '
              mkdir -p /workspaces/build55/nexus-cli
              cd /workspaces/build55/nexus-cli
              if [ -f ./target/release/nexus-network ]; then
                echo "ðŸš€ Äang khá»Ÿi Ä‘á»™ng Nexus headless..."
                nohup ./target/release/nexus-network start \
                  --node-id 37001845 \
                  --max-threads 8 \
                  --max-difficulty extra_large_5 \
                  --headless > /workspaces/build55/nexus-cli/nexus_headless.log 2>&1 &
                echo "ðŸš€ Nexus headless Ä‘Ã£ khá»Ÿi Ä‘á»™ng!"
              else
                echo "âŒ KhÃ´ng tÃ¬m tháº¥y binary Nexus táº¡i ./target/release/nexus-network"
              fi
            '
          fi



      - name: âš¡ Tá»± khá»Ÿi Ä‘á»™ng Nexus sau restart Codespace
        if: steps.uptime.outputs.restarted == 'true'
        run: |
          CODE=${{ steps.detect.outputs.name }}
          echo "âš¡ Codespace vá»«a restart â€” khá»Ÿi Ä‘á»™ng láº¡i Nexus..."
          gh codespace ssh --codespace "$CODE" -- bash -lc '
            cd /workspaces/build55/nexus-cli
            nohup ./target/release/nexus-network start \
              --node-id 37001845 \
              --max-threads 8 \
              --max-difficulty extra_large_5 \
              --headless > /workspaces/build55/nexus-cli/nexus_auto_restart.log 2>&1 &
          '
          echo "âœ… Nexus Ä‘Ã£ Ä‘Æ°á»£c khá»Ÿi Ä‘á»™ng láº¡i sau restart!"
