name: Auto Restart & Keep Codespace Alive

on:
  schedule:
    - cron: "*/15 * * * *"  # Ki·ªÉm tra m·ªói 15 ph√∫t
  workflow_dispatch:

jobs:
  keepalive:
    runs-on: ubuntu-latest
    steps:
      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y gh jq

      - name: Authenticate GitHub CLI
        env:
          GH_TOKEN: ${{ secrets.PERSONAL_TOKEN }}
        run: |
          echo "üîê Authenticating gh CLI..."
          gh auth setup-git
          gh auth status || gh auth login --with-token <<< "${GH_TOKEN}"

      - name: Restart Codespace if stopped
        env:
          GH_TOKEN: ${{ secrets.PERSONAL_TOKEN }}
          CODESPACE_NAME: scary-spooky-coffin-wqv595qjqx42wvg
        run: |
          echo "üöÄ Checking Codespace state for: $CODESPACE_NAME"
          state=$(gh codespace list --json name,state --jq ".[] | select(.name==\"$CODESPACE_NAME\") | .state")
          echo "Current state: $state"
          if [ "$state" != "Available" ]; then
            echo "üåÄ Restarting Codespace: $CODESPACE_NAME"
            curl -X POST \
              -H "Authorization: token $GH_TOKEN" \
              -H "Accept: application/vnd.github+json" \
              "https://api.github.com/user/codespaces/$CODESPACE_NAME/start"
          else
            echo "‚úÖ Codespace is running fine."
          fi

      - name: Auto run your build (optional)
        run: |
          echo "üèóÔ∏è  Simulating build/run..."
          cd /workspaces/build55/nexus-cli
          cargo build --release
          ./target/release/nexus-network start --node-id 37001845 --max-threads 8 --max-difficulty extra_large_5
