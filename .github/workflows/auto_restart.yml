name: KeepAlive + Nexus Auto Supervisor (Final v5 Stable)

on:
  schedule:
    - cron: "*/15 * * * *"  # Kiá»ƒm tra má»—i 15 phÃºt
  workflow_dispatch:

jobs:
  keepalive:
    runs-on: ubuntu-latest
    env:
      PERSONAL_TOKEN: ${{ secrets.PERSONAL_TOKEN }}

    steps:
      - name: ğŸ§° CÃ i cÃ´ng cá»¥ cáº§n thiáº¿t
        run: |
          sudo apt update -y
          sudo apt install -y gh jq curl

      - name: ğŸ” ÄÄƒng nháº­p GitHub CLI
        run: |
          echo "${PERSONAL_TOKEN}" | gh auth login --with-token
          gh auth status || true

      - name: ğŸ§© PhÃ¡t hiá»‡n Codespace Ä‘ang cháº¡y
        id: detect
        run: |
          NAME=$(gh codespace list --json name,state --jq '.[] | select(.state=="Available") | .name' | head -n 1)
          if [ -z "$NAME" ]; then
            echo "âš ï¸ KhÃ´ng cÃ³ Codespace Ä‘ang hoáº¡t Ä‘á»™ng."
            exit 0
          fi
          echo "ğŸ§© Äang xá»­ lÃ½ Codespace: $NAME"
          echo "name=$NAME" >> $GITHUB_OUTPUT

      - name: â±ï¸ Kiá»ƒm tra thá»i gian hoáº¡t Ä‘á»™ng & restart náº¿u gáº§n háº¿t háº¡n
        id: uptime
        run: |
          CODE=${{ steps.detect.outputs.name }}
          START_TIME=$(gh codespace list --json name,lastUsedAt --jq ".[] | select(.name==\"$CODE\") | .lastUsedAt")
          if [ -z "$START_TIME" ]; then
            echo "âš ï¸ KhÃ´ng thá»ƒ xÃ¡c Ä‘á»‹nh thá»i gian báº¯t Ä‘áº§u."
            exit 0
          fi
          START_EPOCH=$(date -d "$START_TIME" +%s)
          NOW_EPOCH=$(date +%s)
          MINUTES=$(( (NOW_EPOCH - START_EPOCH) / 60 ))
          echo "ğŸ•’ Codespace $CODE Ä‘Ã£ cháº¡y $MINUTES phÃºt."
          echo "runtime=$MINUTES" >> $GITHUB_OUTPUT

          if [ "$MINUTES" -ge 355 ]; then
            echo "âš ï¸ Gáº§n háº¿t 6 tiáº¿ng â€” restart..."
            gh codespace stop "$CODE" || true
            sleep 25
            gh codespace start "$CODE" || true
            echo "restarted=true" >> $GITHUB_OUTPUT
          else
            echo "âœ… CÃ²n trong giá»›i háº¡n an toÃ n."
            echo "restarted=false" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ’¤ Gá»­i keep-alive ping
        if: steps.detect.outputs.name != ''
        run: |
          CODE=${{ steps.detect.outputs.name }}
          echo "ğŸ’¤ Gá»­i keep-alive ping cho $CODE..."
          gh codespace ssh -c "$CODE" -- bash -lc '
            mkdir -p /workspaces/build55/keepalive
            echo "[KeepAlive] $(date)" >> /workspaces/build55/keepalive/ping.log
          ' || echo "âš ï¸ Ping lá»—i nháº¹ (Codespace cÃ³ thá»ƒ Ä‘ang táº¡m ngá»§)"
          echo "âœ… Keep-alive ping gá»­i thÃ nh cÃ´ng!"

      - name: ğŸ’» Kiá»ƒm tra tiáº¿n trÃ¬nh Nexus
        run: |
          CODE=${{ steps.detect.outputs.name }}
          echo "ğŸ’» Kiá»ƒm tra tiáº¿n trÃ¬nh Nexus..."
          gh codespace ssh -c "$CODE" -- bash -lc '
            set -e
            cd /workspaces/build55/nexus-cli/clients/cli || exit 1

            PIDS=$(pgrep -f "nexus-network" || true)
            if [ -n "$PIDS" ]; then
              echo "âœ… Nexus Ä‘ang cháº¡y (PID: $PIDS)"
              exit 0
            fi

            echo "âš™ï¸ Nexus chÆ°a cháº¡y â€” chuáº©n bá»‹ khá»Ÿi Ä‘á»™ng headless..."

            BINARY="./target/release/nexus-network"
            if [ ! -f "$BINARY" ]; then
              echo "ğŸ”¨ KhÃ´ng tÃ¬m tháº¥y binary, Ä‘ang build láº¡i..."
              cargo build --release || { echo "âŒ Build tháº¥t báº¡i!"; exit 1; }
            fi

            echo "ğŸš€ Khá»Ÿi Ä‘á»™ng Nexus headless..."
            nohup "$BINARY" start \
              --node-id 37001845 \
              --max-threads 8 \
              --max-difficulty extra_large_5 \
              --headless > /workspaces/build55/nexus-cli/clients/cli/nexus_headless.log 2>&1 &

            echo "âœ… Nexus headless Ä‘Ã£ khá»Ÿi Ä‘á»™ng!"
          ' || echo "âš ï¸ KhÃ´ng thá»ƒ kiá»ƒm tra Nexus (Codespace cÃ³ thá»ƒ Ä‘ang khá»Ÿi Ä‘á»™ng láº¡i)"

      - name: âš¡ Tá»± khá»Ÿi Ä‘á»™ng Nexus sau restart Codespace
        if: steps.uptime.outputs.restarted == 'true'
        run: |
          CODE=${{ steps.detect.outputs.name }}
          echo "âš¡ Codespace vá»«a restart â€” khá»Ÿi Ä‘á»™ng láº¡i Nexus..."
          gh codespace ssh -c "$CODE" -- bash -lc '
            cd /workspaces/build55/nexus-cli/clients/cli
            nohup ./target/release/nexus-network start \
              --node-id 37001845 \
              --max-threads 8 \
              --max-difficulty extra_large_5 \
              --headless > /workspaces/build55/nexus-cli/clients/cli/nexus_auto_restart.log 2>&1 &
          ' || echo "âš ï¸ Restart lá»—i nháº¹ (sáº½ thá»­ láº¡i á»Ÿ láº§n check sau)"
          echo "âœ… Nexus Ä‘Ã£ Ä‘Æ°á»£c khá»Ÿi Ä‘á»™ng láº¡i sau restart!"
