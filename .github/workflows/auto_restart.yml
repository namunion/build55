name: Auto Restart + KeepAlive + Run Nexus (Headless Stable)

on:
  schedule:
    - cron: "*/15 * * * *"
  workflow_dispatch:

jobs:
  maintain:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ§° CÃ i Ä‘áº·t cÃ´ng cá»¥ cáº§n thiáº¿t
        run: |
          sudo apt update -y
          sudo apt install -y gh jq curl

      - name: ğŸ” ÄÄƒng nháº­p GitHub CLI báº±ng PERSONAL_TOKEN
        env:
          GITHUB_TOKEN: ${{ secrets.PERSONAL_TOKEN }}
        run: |
          echo "ÄÄƒng nháº­p GitHub CLI báº±ng token cÃ¡ nhÃ¢n..."
          echo "${{ secrets.PERSONAL_TOKEN }}" | gh auth login --with-token
          gh auth status

      - name: ğŸ§© TÃ¬m Codespace Ä‘ang hoáº¡t Ä‘á»™ng
        id: detect
        run: |
          CODE_NAME=$(gh codespace list --json name,state --jq '.[] | select(.state=="Available") | .name' | head -n 1)
          echo "ğŸ§© Codespace phÃ¡t hiá»‡n: $CODE_NAME"
          echo "name=$CODE_NAME" >> $GITHUB_OUTPUT

      - name: â±ï¸ Kiá»ƒm tra thá»i gian hoáº¡t Ä‘á»™ng vÃ  restart náº¿u gáº§n háº¿t háº¡n
        if: steps.detect.outputs.name != ''
        id: uptime
        env:
          GITHUB_TOKEN: ${{ secrets.PERSONAL_TOKEN }}
        run: |
          CODE_NAME=${{ steps.detect.outputs.name }}
          echo "ğŸ•’ Kiá»ƒm tra thá»i gian hoáº¡t Ä‘á»™ng cá»§a Codespace: $CODE_NAME"

          START_TIME=$(gh codespace list --json name,lastUsedAt --jq ".[] | select(.name==\"$CODE_NAME\") | .lastUsedAt")
          START_EPOCH=$(date -d "$START_TIME" +%s)
          NOW_EPOCH=$(date +%s)
          RUNTIME_MIN=$(( (NOW_EPOCH - START_EPOCH) / 60 ))

          echo "ğŸ•’ Codespace: $CODE_NAME Ä‘Ã£ cháº¡y $RUNTIME_MIN phÃºt"
          echo "runtime=$RUNTIME_MIN" >> $GITHUB_OUTPUT

          if [ "$RUNTIME_MIN" -ge 355 ]; then
            echo "âš ï¸ Codespace sáº¯p háº¿t háº¡n â†’ restart..."
            gh codespace stop --codespace "$CODE_NAME"
            sleep 20
            gh codespace start --codespace "$CODE_NAME"
            echo "ğŸ” Codespace Ä‘Ã£ Ä‘Æ°á»£c restart!"
            echo "restarted=true" >> $GITHUB_OUTPUT
          else
            echo "âœ… CÃ²n trong giá»›i háº¡n an toÃ n."
            echo "restarted=false" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ’¤ Giá»¯ Codespace luÃ´n hoáº¡t Ä‘á»™ng (KeepAlive - Safe)
        if: steps.detect.outputs.name != ''
        env:
          GITHUB_TOKEN: ${{ secrets.PERSONAL_TOKEN }}
        run: |
          CODE_NAME=${{ steps.detect.outputs.name }}
          echo "ğŸ’¤ Gá»­i keep-alive ping cho Codespace: $CODE_NAME"
          gh codespace ssh --codespace "$CODE_NAME" --command '
            TARGET_DIR="/workspaces/build55/keepalive"
            mkdir -p "$TARGET_DIR"
            echo "[KeepAlive] Ping $(date)" >> "$TARGET_DIR/ping.log"
          '
          echo "âœ… Keep-alive ping gá»­i thÃ nh cÃ´ng!"

      - name: ğŸ’» Kiá»ƒm tra tiáº¿n trÃ¬nh Nexus
        if: steps.detect.outputs.name != ''
        id: check_nexus
        env:
          GITHUB_TOKEN: ${{ secrets.PERSONAL_TOKEN }}
        run: |
          CODE_NAME=${{ steps.detect.outputs.name }}
          echo "ğŸ” Kiá»ƒm tra tiáº¿n trÃ¬nh Nexus trong Codespace: $CODE_NAME"

          STATUS=$(gh codespace ssh --codespace "$CODE_NAME" --command '
            if pgrep -x nexus-network >/dev/null 2>&1; then
              echo "running"
            elif grep -q "Starting nexus" /workspaces/build55/nexus-cli/nexus_run.log 2>/dev/null; then
              echo "maybe_running"
            else
              echo "stopped"
            fi
          ')
          echo "Nexus status: $STATUS"
          echo "status=$STATUS" >> $GITHUB_OUTPUT

      - name: ğŸš€ Khá»Ÿi Ä‘á»™ng Nexus headless náº¿u chÆ°a cháº¡y
        if: steps.check_nexus.outputs.status == 'stopped'
        env:
          GITHUB_TOKEN: ${{ secrets.PERSONAL_TOKEN }}
        run: |
          CODE_NAME=${{ steps.detect.outputs.name }}
          echo "âš™ï¸ Nexus chÆ°a cháº¡y â€” khá»Ÿi Ä‘á»™ng á»Ÿ cháº¿ Ä‘á»™ headless..."
          gh codespace ssh --codespace "$CODE_NAME" --command '
            cd /workspaces/build55/nexus-cli || exit 1
            nohup ./target/release/nexus-network start \
              --node-id 37001845 \
              --max-threads 8 \
              --max-difficulty extra_large_5 \
              --headless \
              > /workspaces/build55/nexus-cli/nexus_run.log 2>&1 &
          '
          echo "ğŸš€ Nexus headless Ä‘Ã£ khá»Ÿi Ä‘á»™ng!"

      - name: âœ… BÃ¡o cÃ¡o tráº¡ng thÃ¡i Nexus
        if: steps.detect.outputs.name != ''
        run: |
          echo "ğŸ“Š Tráº¡ng thÃ¡i Nexus cuá»‘i cÃ¹ng: ${{ steps.check_nexus.outputs.status }}"

      - name: ğŸš€ Tá»± Ä‘á»™ng khá»Ÿi Ä‘á»™ng Nexus sau restart
        if: steps.uptime.outputs.restarted == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.PERSONAL_TOKEN }}
        run: |
          CODE_NAME=${{ steps.detect.outputs.name }}
          echo "âš¡ Codespace vá»«a restart, khá»Ÿi Ä‘á»™ng láº¡i Nexus..."
          gh codespace ssh --codespace "$CODE_NAME" --command '
            cd /workspaces/build55/nexus-cli || exit 1
            nohup ./target/release/nexus-network start \
              --node-id 37001845 \
              --max-threads 8 \
              --max-difficulty extra_large_5 \
              --headless \
              > /workspaces/build55/nexus-cli/nexus_auto_restart.log 2>&1 &
          '
          echo "âœ… Nexus headless Ä‘Ã£ tá»± khá»Ÿi Ä‘á»™ng sau restart!"

      - name: âš ï¸ KhÃ´ng cÃ³ Codespace hoáº¡t Ä‘á»™ng
        if: steps.detect.outputs.name == ''
        run: |
          echo "âš ï¸ KhÃ´ng tÃ¬m tháº¥y Codespace nÃ o Ä‘ang hoáº¡t Ä‘á»™ng. HÃ£y má»Ÿ Codespace trÆ°á»›c khi workflow cháº¡y."
