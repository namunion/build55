name: â™»ï¸ Auto Restart + Auto Recover Codespace + Run Nexus

on:
  schedule:
    - cron: "*/15 * * * *"   # Má»—i 15 phÃºt kiá»ƒm tra tráº¡ng thÃ¡i Codespace
    - cron: "0 */6 * * *"    # Má»—i 6 tiáº¿ng restart láº¡i Codespace
  workflow_dispatch:          # Cho phÃ©p báº¥m tay thá»§ cÃ´ng

jobs:
  manage:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ§° Install dependencies
        run: |
          sudo apt update -y
          sudo apt install -y gh jq

      - name: ðŸ” Authenticate GitHub CLI
        env:
          GH_TOKEN: ${{ secrets.PERSONAL_TOKEN }}
        run: |
          echo "$GH_TOKEN" | gh auth login --with-token
          echo "âœ… Logged in as $(gh api user --jq .login)"

      - name: ðŸ”Ž Detect Codespace
        id: detect
        run: |
          CODE=$(gh api user/codespaces --jq '.codespaces[0].name')
          echo "codespace_name=$CODE" >> $GITHUB_OUTPUT
          echo "Detected Codespace: $CODE"

      - name: ðŸ” Check Codespace Status
        id: check
        env:
          CODE: ${{ steps.detect.outputs.codespace_name }}
        run: |
          STATUS=$(gh api user/codespaces/$CODE --jq '.state')
          echo "Current status: $STATUS"
          echo "status=$STATUS" >> $GITHUB_OUTPUT

      - name: â™»ï¸ Restart if Scheduled (every 6h)
        if: github.event.schedule == '0 */6 * * *'
        env:
          CODE: ${{ steps.detect.outputs.codespace_name }}
        run: |
          echo "ðŸ§¹ Restarting codespace $CODE (scheduled)..."
          gh api -X POST user/codespaces/$CODE/stop
          sleep 30
          gh api -X POST user/codespaces/$CODE/start
          echo "âœ… Restart completed!"

      - name: ðŸš€ Start if Stopped (every 15min)
        if: steps.check.outputs.status != 'Available'
        env:
          CODE: ${{ steps.detect.outputs.codespace_name }}
        run: |
          echo "âš¡ Codespace $CODE is stopped. Starting..."
          gh api -X POST user/codespaces/$CODE/start
          echo "âœ… Codespace started!"

      - name: ðŸ—ï¸ Auto build & start Nexus
        if: always()
        env:
          CODE: ${{ steps.detect.outputs.codespace_name }}
        run: |
          echo "ðŸ—ï¸ Building & starting nexus-network in $CODE..."
          gh api user/codespaces/$CODE/exec -f command="cd /workspaces/build55 && cargo build --release && nohup ./target/release/nexus-network start --node-id 37001845 --max-threads 8 --max-difficulty extra_large_5 > nexus.log 2>&1 &"
          echo "âœ… Nexus started successfully."
