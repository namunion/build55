name: Auto Restart + KeepAlive + Run Nexus

on:
  schedule:
    - cron: "*/15 * * * *"   # Kiá»ƒm tra má»—i 15 phÃºt
  workflow_dispatch:

jobs:
  maintain:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ§© CÃ i cÃ´ng cá»¥ cáº§n thiáº¿t
        run: |
          sudo apt update -y
          sudo apt install -y gh jq curl

      - name: ğŸ” ÄÄƒng nháº­p GitHub CLI an toÃ n
        env:
          GH_TOKEN: ${{ secrets.PERSONAL_TOKEN }}
        run: |
          echo "ÄÄƒng nháº­p GitHub CLI báº±ng token cÃ¡ nhÃ¢n..."
          echo "${{ secrets.PERSONAL_TOKEN }}" | gh auth login --with-token
          gh auth status

      - name: ğŸ” TÃ¬m Codespace Ä‘ang hoáº¡t Ä‘á»™ng
        id: detect
        env:
          GH_TOKEN: ${{ secrets.PERSONAL_TOKEN }}
        run: |
          echo "Äang tÃ¬m Codespace Ä‘ang báº­t..."
          name=$(gh codespace list --json name,state --jq '.[] | select(.state=="Available") | .name' | head -n 1)
          echo "ğŸ§© Codespace phÃ¡t hiá»‡n: $name"
          echo "name=$name" >> $GITHUB_OUTPUT

      - name: ğŸ•’ Kiá»ƒm tra thá»i gian hoáº¡t Ä‘á»™ng & restart náº¿u cáº§n
        if: steps.detect.outputs.name != ''
        env:
          GH_TOKEN: ${{ secrets.PERSONAL_TOKEN }}
        run: |
          CODE_NAME=${{ steps.detect.outputs.name }}
          echo "â±ï¸ Kiá»ƒm tra thá»i gian hoáº¡t Ä‘á»™ng cá»§a Codespace: $CODE_NAME"
          START_TIME=$(gh codespace list --json name,updatedAt --jq ".[] | select(.name==\"$CODE_NAME\") | .updatedAt")
          START_EPOCH=$(date -d "$START_TIME" +%s)
          NOW_EPOCH=$(date +%s)
          RUNTIME_MIN=$(( (NOW_EPOCH - START_EPOCH) / 60 ))
          echo "ğŸ“Š Codespace Ä‘Ã£ cháº¡y $RUNTIME_MIN phÃºt"

          if [ "$RUNTIME_MIN" -ge 355 ]; then
            echo "âš ï¸ Gáº§n háº¿t thá»i gian (>$RUNTIME_MIN phÃºt) â†’ restart!"
            gh codespace stop "$CODE_NAME"
            sleep 20
            gh codespace start "$CODE_NAME"
            echo "ğŸ” Codespace Ä‘Ã£ Ä‘Æ°á»£c restart!"
          else
            echo "âœ… CÃ²n trong giá»›i háº¡n an toÃ n ($RUNTIME_MIN phÃºt)."
          fi

      - name: ğŸ’¤ Giá»¯ Codespace luÃ´n hoáº¡t Ä‘á»™ng (Keep-Alive)
        if: steps.detect.outputs.name != ''
        env:
          GH_TOKEN: ${{ secrets.PERSONAL_TOKEN }}
        run: |
          CODE_NAME=${{ steps.detect.outputs.name }}
          echo "ğŸ’¤ Gá»­i keep-alive cho Codespace: $CODE_NAME"
          gh codespace exec --codespace "$CODE_NAME" -- bash -c "
            mkdir -p /workspaces/build55/keepalive && \
            (while true; do echo '[KeepAlive] Ping \$(date)' >> /workspaces/build55/keepalive/ping.log; sleep 300; done) >/dev/null 2>&1 &
          "
          echo "âœ… Keep-alive Ä‘Ã£ cháº¡y ná»n trong Codespace."

      - name: ğŸš€ Kiá»ƒm tra & khá»Ÿi Ä‘á»™ng Nexus náº¿u chÆ°a cháº¡y
        if: steps.detect.outputs.name != ''
        env:
          GH_TOKEN: ${{ secrets.PERSONAL_TOKEN }}
        run: |
          CODE_NAME=${{ steps.detect.outputs.name }}
          echo "ğŸ” Kiá»ƒm tra tiáº¿n trÃ¬nh Nexus trong Codespace: $CODE_NAME"
          RUNNING=$(gh codespace exec --codespace "$CODE_NAME" -- bash -c "pgrep -x nexus-network || true")

          if [ -n "$RUNNING" ]; then
            echo "âœ… Nexus Ä‘ang cháº¡y (PID: $RUNNING), bá» qua."
          else
            echo "âš™ï¸ ChÆ°a cÃ³ Nexus â†’ khá»Ÿi Ä‘á»™ng tiáº¿n trÃ¬nh..."
            gh codespace exec --codespace "$CODE_NAME" -- bash -c "
              cd /workspaces/build55/nexus-cli && \
              nohup ./target/release/nexus-network start \
                --node-id 37001845 \
                --max-threads 8 \
                --max-difficulty extra_large_5 \
                > /workspaces/build55/nexus-cli/nexus_run.log 2>&1 &
            "
            echo "ğŸš€ Nexus Ä‘Ã£ Ä‘Æ°á»£c khá»Ÿi Ä‘á»™ng má»›i!"
          fi

      - name: âš ï¸ ThÃ´ng bÃ¡o náº¿u khÃ´ng cÃ³ Codespace
        if: steps.detect.outputs.name == ''
        run: |
          echo "âš ï¸ KhÃ´ng tÃ¬m tháº¥y Codespace Ä‘ang hoáº¡t Ä‘á»™ng. HÃ£y má»Ÿ Codespace trÆ°á»›c Ä‘á»ƒ workflow cÃ³ thá»ƒ quáº£n lÃ½ vÃ  khá»Ÿi Ä‘á»™ng Nexus."
