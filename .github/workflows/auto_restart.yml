name: â° Nexus Auto KeepAlive

on:
  schedule:
    - cron: "*/10 * * * *"   # cháº¡y má»—i 10 phÃºt
  workflow_dispatch:          # cÃ³ thá»ƒ cháº¡y thá»§ cÃ´ng

jobs:
  keepalive:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      # ðŸ§© Cáº­p nháº­t mÃ´i trÆ°á»ng vÃ  cÃ i dependencies
      - name: âš™ï¸ CÃ i Ä‘áº·t gÃ³i cáº§n thiáº¿t
        run: |
          sudo apt update -y
          sudo apt install -y jq curl

      # ðŸ§¹ Dá»n dáº¹p token máº·c Ä‘á»‹nh
      - name: ðŸ§¹ XÃ³a GH_TOKEN máº·c Ä‘á»‹nh Ä‘á»ƒ trÃ¡nh xung Ä‘á»™t
        run: |
          unset GH_TOKEN

      # ðŸ” ÄÄƒng nháº­p GitHub CLI báº±ng Personal Access Token
      - name: ðŸ” ÄÄƒng nháº­p GitHub CLI
        env:
          GH_TOKEN: ${{ secrets.PERSONAL_TOKEN }}
        run: |
          echo "ÄÄƒng nháº­p GitHub CLI báº±ng token cÃ¡ nhÃ¢n..."
          echo "${GH_TOKEN}" | gh auth login --with-token
          gh auth status

      # ðŸ§© PhÃ¡t hiá»‡n Codespace Ä‘ang hoáº¡t Ä‘á»™ng
      - name: ðŸ§© TÃ¬m Codespace Ä‘ang má»Ÿ
        id: detect
        run: |
          name=$(gh codespace list --json name,state,lastUsedAt --jq '.[] | select(.state=="Available") | .name' | head -n 1)
          if [ -z "$name" ]; then
            echo "âš ï¸ KhÃ´ng tÃ¬m tháº¥y Codespace Ä‘ang hoáº¡t Ä‘á»™ng. HÃ£y má»Ÿ Codespace trÆ°á»›c khi giá»¯ hoáº¡t Ä‘á»™ng."
            exit 0
          fi
          echo "ðŸ§© Codespace phÃ¡t hiá»‡n: $name"
          echo "name=$name" >> $GITHUB_OUTPUT

      # ðŸ•’ Kiá»ƒm tra thá»i gian hoáº¡t Ä‘á»™ng
      - name: â±ï¸ Kiá»ƒm tra thá»i gian hoáº¡t Ä‘á»™ng
        run: |
          CODE_NAME=${{ steps.detect.outputs.name }}
          echo "ðŸ•’ Kiá»ƒm tra thá»i gian hoáº¡t Ä‘á»™ng cá»§a Codespace: $CODE_NAME"
          uptime=$(gh codespace list --json name,lastUsedAt --jq ".[] | select(.name==\"$CODE_NAME\") | .lastUsedAt" | xargs -I{} date -d {} +%s)
          now=$(date +%s)
          diff=$(( (now - uptime) / 60 ))
          echo "â±ï¸ Codespace Ä‘Ã£ cháº¡y $diff phÃºt"
          if [ $diff -gt 240 ]; then
            echo "âš ï¸ Codespace Ä‘Ã£ cháº¡y quÃ¡ 4 giá», sáº½ restart láº¡i."
            gh codespace stop -c "$CODE_NAME"
            sleep 20
            gh codespace start -c "$CODE_NAME"
          else
            echo "âœ… CÃ²n trong giá»›i háº¡n an toÃ n."
          fi

      # ðŸ’¤ KeepAlive + Auto-start Nexus
      - name: ðŸ’« Giá»¯ Codespace hoáº¡t Ä‘á»™ng + Tá»± Ä‘á»™ng khá»Ÿi Ä‘á»™ng Nexus
        if: steps.detect.outputs.name != ''
        run: |
          CODE_NAME=${{ steps.detect.outputs.name }}
          echo "ðŸ’¤ Gá»­i keep-alive ping vÃ  khá»Ÿi Ä‘á»™ng Nexus trong Codespace: $CODE_NAME"
          gh codespace ssh -c "$CODE_NAME" -- bash -lc '
            mkdir -p /workspaces/build55/keepalive;
            echo "[KeepAlive] $(date) â€“ Ping OK" >> /workspaces/build55/keepalive/ping.log;

            # Kiá»ƒm tra Nexus container
            if ! docker ps | grep -q nexus; then
              echo "[Nexus] KhÃ´ng tÃ¬m tháº¥y container Nexus. Äang khá»Ÿi Ä‘á»™ng láº¡i..." >> /workspaces/build55/keepalive/ping.log;
              docker compose -f /workspaces/build55/docker-compose.yml up -d nexus || true;
            else
              echo "[Nexus] Container Nexus Ä‘ang cháº¡y bÃ¬nh thÆ°á»ng." >> /workspaces/build55/keepalive/ping.log;
            fi

            # Cháº¡y tiáº¿n trÃ¬nh keepalive ná»n
            if ! pgrep -f "keepalive-loop" >/dev/null; then
              (while true; do
                echo "[KeepAlive] Ping $(date)" >> /workspaces/build55/keepalive/ping.log;
                sleep 300;
              done) >/dev/null 2>&1 &
            fi
          '
          echo "âœ… KeepAlive & Nexus auto-start Ä‘Ã£ Ä‘Æ°á»£c kÃ­ch hoáº¡t."
