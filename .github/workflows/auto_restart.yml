name: KeepAlive + Nexus Auto Supervisor (Final v6 Stable)

on:
  schedule:
    - cron: "*/15 * * * *"  # Kiแปm tra mแปi 15 phรบt
  workflow_dispatch:

jobs:
  keepalive:
    runs-on: ubuntu-latest
    env:
      PERSONAL_TOKEN: ${{ secrets.PERSONAL_TOKEN }}

    steps:
      - name: ๐งฐ Cรi cรดng cแปฅ cแบงn thiแบฟt
        run: |
          sudo apt update -y
          sudo apt install -y gh jq curl

      - name: ๐ ฤฤng nhแบญp GitHub CLI
        run: |
          echo "${PERSONAL_TOKEN}" | gh auth login --with-token
          gh auth status || true

      - name: ๐งฉ Xรกc ฤแปnh Codespace ฤang hoแบกt ฤแปng
        id: detect
        run: |
          NAME=$(gh codespace list --json name,state --jq '.[] | select(.state=="Available") | .name' | head -n 1)
          if [ -z "$NAME" ]; then
            echo "โ๏ธ Khรดng cรณ Codespace nรo ฤang hoแบกt ฤแปng."
            exit 0
          fi
          echo "๐งฉ ฤang xแปญ lรฝ Codespace: $NAME"
          echo "name=$NAME" >> $GITHUB_OUTPUT

      - name: โฑ๏ธ Kiแปm tra thแปi gian hoแบกt ฤแปng & restart nแบฟu gแบงn hแบฟt hแบกn
        id: uptime
        run: |
          CODE=${{ steps.detect.outputs.name }}
          START_TIME=$(gh codespace list --json name,lastUsedAt --jq ".[] | select(.name==\"$CODE\") | .lastUsedAt")
          [ -z "$START_TIME" ] && echo "โ๏ธ Khรดng xรกc ฤแปnh ฤฦฐแปฃc thแปi gian bแบฏt ฤแบงu." && exit 0
          START_EPOCH=$(date -d "$START_TIME" +%s)
          NOW_EPOCH=$(date +%s)
          MINUTES=$(( (NOW_EPOCH - START_EPOCH) / 60 ))
          echo "๐ Codespace $CODE ฤรฃ chแบกy $MINUTES phรบt."
          echo "runtime=$MINUTES" >> $GITHUB_OUTPUT

          if [ "$MINUTES" -ge 355 ]; then
            echo "โ๏ธ Gแบงn hแบฟt 6 tiแบฟng โ restart..."
            gh codespace stop -c "$CODE"
            sleep 25
            gh codespace start -c "$CODE"
            echo "restarted=true" >> $GITHUB_OUTPUT
          else
            echo "โ Cรฒn trong giแปi hแบกn an toรn."
            echo "restarted=false" >> $GITHUB_OUTPUT
          fi

      - name: ๐ค Gแปญi keep-alive ping
        if: steps.detect.outputs.name != ''
        run: |
          CODE=${{ steps.detect.outputs.name }}
          echo "๐ค Gแปญi keep-alive ping cho $CODE..."
          gh codespace ssh -c "$CODE" -- bash -lc '
            mkdir -p /workspaces/build55/keepalive
            echo "[KeepAlive] $(date)" >> /workspaces/build55/keepalive/ping.log
          ' || echo "โ๏ธ Ping lแปi nhแบน (bแป qua)"
          echo "โ Keep-alive ping gแปญi thรnh cรดng!"

      - name: ๐ป Kiแปm tra & tแปฑ khแปi ฤแปng Nexus (nแบฟu dแปซng)
        run: |
          CODE=${{ steps.detect.outputs.name }}
          echo "๐ป Kiแปm tra tiแบฟn trรฌnh Nexus..."
          gh codespace ssh -c "$CODE" -- bash -c '
            set -e
            cd /workspaces/build55/nexus-cli/clients/cli || exit 1

            PIDS=$(pgrep -f "nexus-network" || true)
            if [ -n "$PIDS" ]; then
              echo "โ Nexus ฤang chแบกy (PID: $PIDS)"
              exit 0
            fi

            BINARY="./target/release/nexus-network"
            if [ ! -f "$BINARY" ]; then
              echo "โ Khรดng tรฌm thแบฅy binary tแบกi $BINARY"
              exit 1
            fi

            echo "โ๏ธ Nexus chฦฐa chแบกy โ khแปi ฤแปng headless..."
            nohup "$BINARY" start \
              --node-id 37252227 \
              --max-threads 8 \
              --max-difficulty extra_large_5 \
              --headless > nexus_headless.log 2>&1 &
            echo "โ Nexus headless ฤรฃ khแปi ฤแปng!"
          ' || echo "โ๏ธ SSH lแปi nhแบน โ bแป qua"

      - name: โก Tแปฑ khแปi ฤแปng Nexus sau restart Codespace
        if: steps.uptime.outputs.restarted == 'true'
        run: |
          CODE=${{ steps.detect.outputs.name }}
          echo "โก Codespace vแปซa restart โ khแปi ฤแปng lแบกi Nexus..."
          gh codespace ssh -c "$CODE" -- bash -c '
            cd /workspaces/build55/nexus-cli/clients/cli || exit 1
            nohup ./target/release/nexus-network start \
              --node-id 37252227 \
              --max-threads 8 \
              --max-difficulty extra_large_5 \
              --headless > nexus_auto_restart.log 2>&1 &
            echo "โ Nexus ฤรฃ khแปi ฤแปng lแบกi!"
          ' || echo "โ๏ธ SSH lแปi nhแบน โ bแป qua"
