name: Auto KeepAlive + Nexus Runner (Final v2)

on:
  schedule:
    - cron: "*/15 * * * *"
  workflow_dispatch:

jobs:
  maintain:
    runs-on: ubuntu-latest
    env:
      PERSONAL_TOKEN: ${{ secrets.PERSONAL_TOKEN }}

    steps:
      - name: ðŸ§° CÃ i cÃ´ng cá»¥ cáº§n thiáº¿t
        run: |
          sudo apt update -y
          sudo apt install -y gh jq curl

      - name: ðŸ” ÄÄƒng nháº­p GitHub CLI báº±ng PERSONAL_TOKEN
        run: |
          echo "ðŸ§¹ Dá»n token cÅ©..."
          unset GH_TOKEN
          unset GITHUB_TOKEN
          rm -rf ~/.config/gh
          echo "${PERSONAL_TOKEN}" | gh auth login --hostname github.com --with-token
          gh auth status || true

      - name: ðŸ§© PhÃ¡t hiá»‡n Codespace Ä‘ang hoáº¡t Ä‘á»™ng
        id: detect
        run: |
          name=$(gh codespace list --json name,state,lastUsedAt --jq '.[] | select(.state=="Available") | .name' | head -n 1)
          if [ -z "$name" ]; then
            echo "âš ï¸ KhÃ´ng cÃ³ Codespace nÃ o Ä‘ang hoáº¡t Ä‘á»™ng!"
          else
            echo "ðŸ§© Codespace phÃ¡t hiá»‡n: $name"
            echo "name=$name" >> $GITHUB_OUTPUT
          fi

      - name: â±ï¸ Kiá»ƒm tra uptime
        if: steps.detect.outputs.name != ''
        id: uptime
        run: |
          CODE_NAME=${{ steps.detect.outputs.name }}
          START_TIME=$(gh codespace list --json name,lastUsedAt --jq ".[] | select(.name==\"$CODE_NAME\") | .lastUsedAt")
          START_EPOCH=$(date -d "$START_TIME" +%s)
          NOW_EPOCH=$(date +%s)
          RUNTIME_MIN=$(( (NOW_EPOCH - START_EPOCH) / 60 ))
          echo "ðŸ•’ Codespace $CODE_NAME Ä‘Ã£ cháº¡y $RUNTIME_MIN phÃºt."
          echo "runtime=$RUNTIME_MIN" >> $GITHUB_OUTPUT

      - name: ðŸ’¤ Gá»­i keep-alive ping
        if: steps.detect.outputs.name != ''
        run: |
          CODE_NAME=${{ steps.detect.outputs.name }}
          echo "ðŸ’¤ Gá»­i keep-alive ping cho $CODE_NAME"
          gh codespace ssh --codespace "$CODE_NAME" -- bash -lc "mkdir -p /workspaces/build55/keepalive && echo '[KeepAlive] $(date)' >> /workspaces/build55/keepalive/ping.log"
          echo "âœ… Keep-alive ping gá»­i thÃ nh cÃ´ng!"

      - name: ðŸ’» Kiá»ƒm tra tiáº¿n trÃ¬nh Nexus
        if: steps.detect.outputs.name != ''
        id: checknexus
        run: |
          CODE_NAME=${{ steps.detect.outputs.name }}
          echo "ðŸ”Ž Kiá»ƒm tra tiáº¿n trÃ¬nh Nexus trÃªn $CODE_NAME..."
          RUNNING=$(gh codespace ssh --codespace "$CODE_NAME" -- bash -lc "pgrep -f nexus-network || true")
          if [ -n "$RUNNING" ]; then
            echo "âœ… Nexus Ä‘ang cháº¡y (PID: $RUNNING)"
            echo "nexus_running=true" >> $GITHUB_OUTPUT
          else
            echo "âš™ï¸ Nexus chÆ°a cháº¡y."
            echo "nexus_running=false" >> $GITHUB_OUTPUT
          fi

      - name: ðŸš€ Khá»Ÿi Ä‘á»™ng Nexus náº¿u chÆ°a cháº¡y
        if: steps.checknexus.outputs.nexus_running == 'false'
        run: |
          CODE_NAME=${{ steps.detect.outputs.name }}
          echo "âš™ï¸ Khá»Ÿi Ä‘á»™ng Nexus headless..."
          gh codespace ssh --codespace "$CODE_NAME" -- bash -lc "cd /workspaces/build55/nexus-cli && nohup ./target/release/nexus-network start --node-id 37001845 --max-threads 8 --max-difficulty extra_large_5 --headless > /workspaces/build55/nexus-cli/nexus_headless.log 2>&1 &"
          echo "ðŸš€ Nexus headless Ä‘Ã£ khá»Ÿi Ä‘á»™ng!"

      - name: ðŸ”„ Restart Codespace náº¿u quÃ¡ 5h55
        if: steps.uptime.outputs.runtime != '' && steps.uptime.outputs.runtime > 355
        id: restart
        run: |
          CODE_NAME=${{ steps.detect.outputs.name }}
          echo "âš ï¸ Codespace $CODE_NAME Ä‘Ã£ cháº¡y hÆ¡n 5h55 â€” thá»±c hiá»‡n restart..."
          gh codespace stop --codespace "$CODE_NAME"
          sleep 40
          gh codespace start --codespace "$CODE_NAME"
          echo "restarted=true" >> $GITHUB_OUTPUT
          echo "âœ… Restart thÃ nh cÃ´ng!"

      - name: âš¡ Tá»± Ä‘á»™ng khá»Ÿi Ä‘á»™ng láº¡i Nexus sau restart
        if: steps.restart.outputs.restarted == 'true'
        run: |
          CODE_NAME=${{ steps.detect.outputs.name }}
          echo "â³ Äá»£i Codespace $CODE_NAME khá»Ÿi Ä‘á»™ng láº¡i..."
          sleep 60
          echo "âš¡ Khá»Ÿi Ä‘á»™ng láº¡i Nexus sau restart..."
          gh codespace ssh --codespace "$CODE_NAME" -- bash -lc "cd /workspaces/build55/nexus-cli && nohup ./target/release/nexus-network start --node-id 37001845 --max-threads 8 --max-difficulty extra_large_5 --headless > /workspaces/build55/nexus-cli/nexus_auto_restart.log 2>&1 &"
          echo "âœ… Nexus Ä‘Ã£ khá»Ÿi Ä‘á»™ng láº¡i sau restart!"
